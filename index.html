<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Network Checker</title>
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
.container { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
.network-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #f8f9fa; border-radius: 4px; overflow: hidden; }
.network-table th, .network-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
.network-table th { background-color: #e9ecef; font-weight: 600; color: #495057; width: 40%; }
.network-table tr:last-child td { border-bottom: none; }
.loading { text-align: center; color: #666; font-style: italic; padding: 20px; }
.error { color: #dc3545; background-color: #ffe6e6; border: 1px solid #dc3545; padding: 10px; border-radius: 4px; margin-top: 10px; }
.refresh-button { display: block; margin: 20px auto 0; padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
.refresh-button:hover { background-color: #2980b9; }
.header { font-size: 18px; font-weight: 600; margin-top: 20px; color: #2c3e50; border-bottom: 1px solid #3498db; padding-bottom: 5px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
<h1>Network Checker üïµÔ∏è‚Äç‚ôÇÔ∏è</h1>
<div id="output" class="loading">Klik tombol di bawah untuk memulai deteksi jaringan...</div>

<div style="margin-top: 20px;">
  <label for="ssidInput"><b>SSID:</b></label>
  <input 
    type="text" 
    id="ssidInput" 
    placeholder="Masukkan nama WiFi (SSID)" 
    style="width:100%; margin-top:10px; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:14px;"
  >
  <div id="ssidStatus" style="margin-top:10px; font-size:13px;"></div>
</div>

<button class="refresh-button" onclick="detectNetwork()">Deteksi Sekarang</button>
</div>

<script>
// --- Konfigurasi Supabase ---
const supabaseUrl = 'https://bbsrfxzdiocqnkpxbgvj.supabase.co';
const supabaseKey = 'sb_publishable_fZZac4_6V984F8q7es5vRQ_eAXtqUdb';
const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

// --- Fungsi untuk mengambil IP Publik ---
async function detectPublicIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        if (!response.ok) throw new Error('Gagal menghubungi API');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        console.error("Gagal mendeteksi IP Publik:", error);
        return "Tidak dapat dideteksi";
    }
}

// --- Fungsi utama untuk mendeteksi semua informasi jaringan ---
async function detectNetwork() {
    const output = document.getElementById('output');
    const statusDiv = document.getElementById('ssidStatus');
    output.className = 'loading';
    output.textContent = 'Mendeteksi informasi jaringan, mohon tunggu...';
    statusDiv.textContent = '';

    // 1. Dapatkan IP Publik
    const publicIP = await detectPublicIP();
    
    // 2. Dapatkan IP Privat via WebRTC
    const privateIPs = await detectPrivateIPs();

    // 3. Hitung informasi jaringan lainnya
    let subnetMask = "Tidak dapat diestimasi", defaultGateway = "Tidak dapat diestimasi", networkId = "Tidak dapat diestimasi";
    if (privateIPs.all.length > 0) {
        const primaryIP = privateIPs.all[0];
        const ipParts = primaryIP.split(".").map(Number);
        let maskParts;

        if (ipParts[0] === 10) maskParts = [255, 0, 0, 0];
        else if (ipParts[0] === 172 && ipParts[1] >= 16 && ipParts[1] <= 31) maskParts = [255, 255, 0, 0];
        else if (ipParts[0] === 192 && ipParts[1] === 168) maskParts = [255, 255, 255, 0];

        if (maskParts) {
            subnetMask = maskParts.join('.');
            const networkIdParts = ipParts.map((part, index) => part & maskParts[index]);
            networkId = networkIdParts.join('.');
            defaultGateway = `${networkIdParts[0]}.${networkIdParts[1]}.${networkIdParts[2]}.1`;
        }
    }

    // 4. Render hasil ke HTML
    renderResults({
        publicIP,
        privateIPs,
        subnetMask,
        defaultGateway,
        networkId
    });

    // 5. Simpan SSID otomatis ke Supabase jika diisi
    const ssid = document.getElementById('ssidInput').value.trim();
    if (ssid) {
        try {
            const now = new Date().toISOString();
            const { error } = await supabase.from('user_network').upsert({
                ssid: ssid,
                ip_address: publicIP,
                last_seen: now
            }, { onConflict: ['ssid'] });

            if (error) throw error;
            statusDiv.textContent = `‚úÖ SSID "${ssid}" berhasil disimpan dengan IP ${publicIP}`;
            statusDiv.style.color = 'green';
        } catch (err) {
            console.error(err);
            statusDiv.textContent = `‚ùå Gagal menyimpan SSID: ${err.message}`;
            statusDiv.style.color = 'red';
        }
    }
}

// --- Deteksi IP Privat ---
function detectPrivateIPs() {
    return new Promise(resolve => {
        const RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection;
        if (!RTCPeerConnection) return resolve({ all: [], mdnsObserved: false });

        const pc = new RTCPeerConnection({ iceServers: [] });
        const ips = new Set();
        let mdnsObserved = false;
        
        pc.onicecandidate = (event) => {
            if (!event || !event.candidate) return;
            const cand = event.candidate.candidate;
            if (cand.includes(".local")) mdnsObserved = true;
            
            const match = cand.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
            if (match && match[1] !== "127.0.0.1") {
                ips.add(match[1]);
            }
        };

        pc.createDataChannel("test");
        pc.createOffer().then(offer => pc.setLocalDescription(offer));
        setTimeout(() => {
            pc.close();
            resolve({ all: Array.from(ips), mdnsObserved });
        }, 500);
    });
}

// --- Render hasil ke tabel ---
function renderResults(data) {
    const output = document.getElementById('output');
    output.innerHTML = '';
    output.className = '';

    let privateHtml = `
        <div class="header">Informasi IP Privat (Lokal)</div>
        <table class="network-table">
            <tr><th>Semua IP Privat Terdeteksi</th><td>${data.privateIPs.all.length > 0 ? data.privateIPs.all.join(', ') : 'Tidak ada'}</td></tr>
            <tr><th>Subnet Mask (Estimasi)</th><td>${data.subnetMask}</td></tr>
            <tr><th>Default Gateway (Estimasi)</th><td>${data.defaultGateway}</td></tr>
            <tr><th>Network ID (Dihitung)</th><td>${data.networkId}</td></tr>
            ${data.privateIPs.mdnsObserved ? `<tr><th>Status Privasi</th><td>‚ö†Ô∏è Browser mungkin menyamarkan IP lokal (mDNS)</td></tr>` : ''}
        </table>`;

    let publicHtml = `
        <div class="header">Informasi IP Publik</div>
        <table class="network-table">
            <tr><th>Alamat IP Publik</th><td>${data.publicIP}</td></tr>
        </table>`;

    output.innerHTML = privateHtml + publicHtml;
}
</script>

</body>
</html>
