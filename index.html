<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Network Info</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .network-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #f8f9fa;
      border-radius: 4px;
      overflow: hidden;
    }
    .network-table th, .network-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    .network-table th {
      background-color: #e9ecef;
      font-weight: 600;
      color: #495057;
      width: 40%;
    }
    .network-table tr:last-child td { border-bottom: none; }
    .loading { text-align: center; color: #666; font-style: italic; padding: 20px; }
    .error { color: #dc3545; background-color: #ffe6e6; border: 1px solid #dc3545; padding: 10px; border-radius: 4px; margin-top: 10px; }
    .refresh-button {
      display: block;
      margin: 20px auto 0;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .refresh-button:hover { background-color: #2980b9; }
    #ssidInput { width:100%; margin-top:10px; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:14px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Network Information</h1>
    <div id="output" class="loading">Klik "Refresh Data" untuk memulai deteksi jaringan...</div>
    <div style="margin-top: 20px;">
      <label for="ssidInput"><b>SSID:</b></label>
      <input type="text" id="ssidInput" placeholder="Masukkan nama WiFi (SSID)">
      <div id="ssidStatus" style="margin-top:10px; font-size:13px;"></div>
    </div>
   <button id="fetchBtn" class="refresh-button">Refresh Data</button>
  </div>
</body>

  <script>
    const outputDiv = document.getElementById('output');
    const fetchBtn = document.getElementById('fetchBtn');

    // --- Fungsi Utama untuk Mengambil dan Menampilkan Info Jaringan ---
    async function getAndDisplayNetworkInfo() {
      outputDiv.className = 'loading';
      outputDiv.textContent = 'Mendeteksi informasi jaringan...';
      fetchBtn.disabled = true;

      try {
        // 1. Dapatkan hanya IP privat dari sisi klien
        const privateIPs = await getPrivateIPsViaWebRTC();
        const privateIP = privateIPs[0] || '';
        const ssid = document.getElementById('ssidInput').value || '';

        // 2. Panggil backend, kirim IP privat dan SSID
        const apiUrl = `/api/network?privateIp=${encodeURIComponent(privateIP)}&ssid=${encodeURIComponent(ssid)}`;
        const response = await fetch(apiUrl);
        const backendData = await response.json();

        if (!response.ok) {
          throw new Error(backendData.message || `Terjadi error di server: ${response.statusText}`);
        }

        // 3. Render hasil yang diterima dari backend
        // Backend sekarang menjadi satu-satunya sumber kebenaran
        const displayData = {
          publicIp: backendData.publicIp || 'Tidak terdeteksi',
          privateIPs: privateIPs, // Tampilkan semua IP privat yang terdeteksi
          subnetMask: backendData.subnetMask || 'Tidak terdeteksi',
          gateway: backendData.defaultGateway || 'Tidak terdeteksi',
          networkId: backendData.networkId || 'Tidak dapat dihitung'
        };

        renderResults(displayData);

      } catch (error) {
        console.error('Gagal mengambil informasi jaringan:', error);
        outputDiv.className = 'error';
        outputDiv.innerHTML = `‚ùå Terjadi kesalahan: ${error.message}.<br>Pastikan Anda menjalankan ini dari server pengembangan (vercel dev) atau setelah di-deploy.`;
      } finally {
        fetchBtn.disabled = false;
      }
    }

    // --- Ambil IP Privat via WebRTC ---
    function getPrivateIPsViaWebRTC() {
      return new Promise((resolve, reject) => {
        const RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection;
        if (!RTCPeerConnection) {
          return resolve(['Tidak didukung oleh browser']);
        }
        
        const ips = new Set();
        const pc = new RTCPeerConnection({ iceServers: [] });
        pc.createDataChannel('');

        pc.onicecandidate = (event) => {
          if (event.candidate && event.candidate.candidate) {
            const match = event.candidate.candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
            if (match && match[1] && match[1] !== '127.0.0.1') {
              ips.add(match[1]);
            }
          } else {
            // Kandidat selesai dikumpulkan
            pc.close();
            if (ips.size > 0) {
              resolve([...ips]);
            } else {
              // Beri sedikit waktu lagi jika belum ada
              setTimeout(() => {
                pc.close();
                resolve(ips.size > 0 ? [...ips] : ['Tidak terdeteksi']);
              }, 1000);
            }
          }
        };
        
        pc.createOffer()
          .then(offer => pc.setLocalDescription(offer))
          .catch(err => {
            console.error("WebRTC offer error:", err);
            reject(err);
          });

        // Timeout untuk memastikan promise selesai
        setTimeout(() => {
            pc.close();
            resolve(ips.size > 0 ? [...ips] : ['Tidak terdeteksi']);
        }, 2000);
      });
    }

    // --- Hitung Network ID ---
    function calculateNetworkId(ip, subnetMask) {
      if (!ip || !subnetMask || ip.includes('Tidak') || subnetMask.includes('Tidak')) {
        return 'Tidak dapat dihitung';
      }
      try {
        const ipParts = ip.split('.').map(Number);
        const maskParts = subnetMask.split('.').map(Number);
        const networkParts = ipParts.map((part, i) => part & maskParts[i]);
        return networkParts.join('.');
      } catch {
        return 'Gagal menghitung';
      }
    }

    // --- Render Tabel Hasil ---
    function renderResults(data) {
      outputDiv.className = '';
      outputDiv.innerHTML = `
        <table class="network-table">
          <tr><th>IP Publik</th><td>${data.publicIp}</td></tr>
          <tr><th>IP Privat (WebRTC)</th><td>${data.privateIPs.join(', ')}</td></tr>
          <tr><th>Subnet Mask</th><td>${data.subnetMask}</td></tr>
          <tr><th>Default Gateway</th><td>${data.gateway}</td></tr>
          <tr><th>Network ID</th><td>${data.networkId}</td></tr>
        </table>
      `;
    }

    // --- Event Listener ---
    document.addEventListener('DOMContentLoaded', () => {
      fetchBtn.addEventListener('click', getAndDisplayNetworkInfo);
    });
  </script>
</html>
