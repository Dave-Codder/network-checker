<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Network Checker</title>
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
.container { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
.network-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #f8f9fa; border-radius: 4px; overflow: hidden; }
.network-table th, .network-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
.network-table th { background-color: #e9ecef; font-weight: 600; color: #495057; width: 40%; }
.network-table tr:last-child td { border-bottom: none; }
.loading { text-align: center; color: #666; font-style: italic; padding: 20px; }
.error { color: #dc3545; background-color: #ffe6e6; border: 1px solid #dc3545; padding: 10px; border-radius: 4px; margin-top: 10px; }
.refresh-button { display: block; margin: 20px auto 0; padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
.refresh-button:hover { background-color: #2980b9; }
.header { font-size: 18px; font-weight: 600; margin-top: 20px; color: #2c3e50; border-bottom: 1px solid #3498db; padding-bottom: 5px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
<h1>Network Checker üïµÔ∏è‚Äç‚ôÇÔ∏è</h1>
<div id="output" class="loading">Klik tombol di bawah untuk memulai deteksi jaringan...</div>
<div style="margin-top: 20px;">
  <label for="ssidInput"><b>SSID:</b></label>
  <input type="text" id="ssidInput" placeholder="Masukkan nama WiFi (SSID)">
  <button onclick="saveSSID()">Simpan SSID</button>
</div>
<button class="refresh-button" onclick="detectNetwork()">Deteksi Sekarang</button>
</div>

<script>
// --- Konfigurasi Supabase ---
const supabaseUrl = 'https://bbsrfxzdiocqnkpxbgvj.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJic3JmeHpkaW9jcW5rcHhiZ3ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3Mjg4NjIsImV4cCI6MjA3NDMwNDg2Mn0.hDSjMPDLp9IyzbO6Zs2VeeK5Hh-BkxIobtG92KUHK4U';
const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

// --- Fungsi untuk menyimpan SSID ke Supabase ---
async function saveSSID() {
    const ssid = document.getElementById('ssidInput').value.trim();
    if (!ssid) {
        alert('Nama SSID tidak boleh kosong.');
        return;
    }

    try {
        const ip = await detectPublicIP();
        const now = new Date().toISOString(); // --- PERBAIKAN: Dapatkan timestamp saat ini ---

        // --- PERBAIKAN: Tambahkan 'last_seen' saat melakukan upsert ---
        // Pastikan Anda memiliki kolom 'last_seen' dengan tipe 'timestamp' atau 'timestamptz' di tabel Supabase
        const { error } = await supabase.from('user_network')
            .upsert({ 
                ssid: ssid, 
                ip_address: ip,
                last_seen: now 
            }, { 
                onConflict: 'ssid' 
            });

        if (error) {
            throw error;
        }
        
        alert(`SSID "${ssid}" berhasil disimpan dengan IP publik ${ip}.`);
    } catch (error) {
        console.error('Gagal menyimpan SSID:', error);
        alert('Gagal menyimpan SSID: ' + error.message);
    }
}

// --- Fungsi untuk mengambil IP Publik dari API ipify ---
async function detectPublicIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        if (!response.ok) throw new Error('Gagal menghubungi API');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        console.error("Gagal mendeteksi IP Publik:", error);
        return "Tidak dapat dideteksi";
    }
}

// --- Fungsi utama untuk mendeteksi semua informasi jaringan ---
async function detectNetwork() {
    const output = document.getElementById('output');
    output.className = 'loading';
    output.textContent = 'Mendeteksi informasi jaringan, mohon tunggu...';

    // 1. Dapatkan IP Publik
    const publicIP = await detectPublicIP();
    
    // 2. Dapatkan IP Privat via WebRTC
    const privateIPs = await detectPrivateIPs();

    // 3. Hitung informasi jaringan lainnya (estimasi)
    let subnetMask = "Tidak dapat diestimasi", defaultGateway = "Tidak dapat diestimasi", networkId = "Tidak dapat diestimasi";
    if (privateIPs.all.length > 0) {
        const primaryIP = privateIPs.all[0]; // Gunakan IP pertama sebagai referensi
        const ipParts = primaryIP.split(".").map(Number);
        let maskParts;

        // Estimasi subnet mask berdasarkan kelas IP privat yang umum
        if (ipParts[0] === 10) {
            maskParts = [255, 0, 0, 0]; // Umum untuk Kelas A
        } else if (ipParts[0] === 172 && ipParts[1] >= 16 && ipParts[1] <= 31) {
            maskParts = [255, 255, 0, 0]; // Asumsi umum /16 untuk jaringan lokal
        } else if (ipParts[0] === 192 && ipParts[1] === 168) {
            maskParts = [255, 255, 255, 0]; // Paling umum untuk jaringan rumahan/kecil
        }

        if (maskParts) {
            subnetMask = maskParts.join('.');
            
            // --- PERBAIKAN: Perhitungan Network ID yang akurat menggunakan bitwise AND ---
            const networkIdParts = ipParts.map((part, index) => part & maskParts[index]);
            networkId = networkIdParts.join('.');

            // Estimasi Default Gateway (biasanya alamat .1 di dalam network ID)
            defaultGateway = `${networkIdParts[0]}.${networkIdParts[1]}.${networkIdParts[2]}.1`;
        }
    }

    // 4. Render semua hasil ke HTML
    renderResults({
        publicIP,
        privateIPs,
        subnetMask,
        defaultGateway,
        networkId
    });

    // 5. Cek SSID di Supabase jika ada input
    const ssid = document.getElementById('ssidInput').value.trim();
    if (ssid) {
        checkSSIDinSupabase(ssid);
    }
}

// --- Fungsi terpisah untuk deteksi IP Privat ---
function detectPrivateIPs() {
    return new Promise(resolve => {
        const RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection;
        if (!RTCPeerConnection) return resolve({ all: [], mdnsObserved: false });

        const pc = new RTCPeerConnection({ iceServers: [] });
        const ips = new Set();
        let mdnsObserved = false;
        
        pc.onicecandidate = (event) => {
            if (!event || !event.candidate) return;
            const cand = event.candidate.candidate;
            if (cand.includes(".local")) mdnsObserved = true;
            
            const match = cand.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
            if (match && match[1] !== "127.0.0.1") {
                ips.add(match[1]);
            }
        };

        pc.createDataChannel("test");
        pc.createOffer().then(offer => pc.setLocalDescription(offer));

        // Tunggu sebentar agar kandidat ICE terkumpul
        setTimeout(() => {
            pc.close();
            resolve({ all: Array.from(ips), mdnsObserved });
        }, 500); // Waktu tunggu sedikit lebih lama untuk hasil lebih andal
    });
}

// --- Fungsi terpisah untuk merender hasil ke tabel ---
function renderResults(data) {
    const output = document.getElementById('output');
    output.innerHTML = ''; // Kosongkan output
    output.className = '';

    // Tabel IP Privat
    let privateHtml = `
        <div class="header">Informasi IP Privat (Lokal)</div>
        <table class="network-table">
            <tr><th>Semua IP Privat Terdeteksi</th><td>${data.privateIPs.all.length > 0 ? data.privateIPs.all.join(', ') : 'Tidak ada'}</td></tr>
            <tr><th>Subnet Mask (Estimasi)</th><td>${data.subnetMask}</td></tr>
            <tr><th>Default Gateway (Estimasi)</th><td>${data.defaultGateway}</td></tr>
            <tr><th>Network ID (Dihitung)</th><td>${data.networkId}</td></tr>
            ${data.privateIPs.mdnsObserved ? `<tr><th>Status Privasi</th><td>‚ö†Ô∏è Browser mungkin menyamarkan IP lokal (mDNS)</td></tr>` : ''}
        </table>`;

    // Tabel IP Publik
    let publicHtml = `
        <div class="header">Informasi IP Publik</div>
        <table class="network-table">
            <tr><th>Alamat IP Publik</th><td>${data.publicIP}</td></tr>
        </table>`;

    output.innerHTML = privateHtml + publicHtml;
}

// --- Fungsi terpisah untuk cek SSID di Supabase ---
async function checkSSIDinSupabase(ssid) {
    const { data, error } = await supabase.from('user_network').select('*').eq('ssid', ssid).single();
    
    if (data) {
        const output = document.getElementById('output');
        const lastSeenDate = new Date(data.last_seen).toLocaleString('id-ID');

        let ssidHtml = `
            <div class="header">Informasi SSID dari Database</div>
            <table class="network-table">
                <tr><th>SSID Tersimpan</th><td>${data.ssid}</td></tr>
                <tr><th>IP Terakhir Terlihat</th><td>${data.ip_address}</td></tr>
                <tr><th>Waktu Terakhir Terlihat</th><td>${lastSeenDate}</td></tr>
            </table>`;
        output.innerHTML += ssidHtml;
    }
}
</script>

</body>
</html>