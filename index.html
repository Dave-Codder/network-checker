<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Network Checker</title>
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
.container { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
.network-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #f8f9fa; border-radius: 4px; overflow: hidden; }
.network-table th, .network-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
.network-table th { background-color: #e9ecef; font-weight: 600; color: #495057; width: 40%; }
.network-table tr:last-child td { border-bottom: none; }
.loading { text-align: center; color: #666; font-style: italic; padding: 20px; }
.error { color: #dc3545; background-color: #ffe6e6; border: 1px solid #dc3545; padding: 10px; border-radius: 4px; margin-top: 10px; }
.refresh-button { display: block; margin: 20px auto 0; padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
.refresh-button:hover { background-color: #2980b9; }
.header { font-size: 18px; font-weight: 600; margin-top: 20px; color: #2c3e50; border-bottom: 1px solid #3498db; padding-bottom: 5px; }
</style>
<!-- Import Supabase v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // --- Konfigurasi Supabase ---
  const supabaseUrl = "https://bbsrfxzdiocqnkpxbgvj.supabase.co";
  const supabaseKey = "YOUR_PUBLIC_ANON_KEY"; // ganti dengan key anon dari Supabase
  const { createClient } = supabase;
  const supabaseClient = createClient(supabaseUrl, supabaseKey);
</script>
</head>
<body>

<div class="container">
<h1>Network Checker üïµÔ∏è‚Äç‚ôÇÔ∏è</h1>
<div id="output" class="loading">Klik tombol di bawah untuk memulai deteksi jaringan...</div>

<div style="margin-top: 20px;">
  <label for="ssidInput"><b>SSID:</b></label>
  <input 
    type="text" 
    id="ssidInput" 
    placeholder="Masukkan nama WiFi (SSID)" 
    style="width:100%; margin-top:10px; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:14px;"
  >
  <div id="ssidStatus" style="margin-top:10px; font-size:13px;"></div>
</div>

<button class="refresh-button" onclick="detectNetwork()">Deteksi Sekarang</button>
</div>

<script>
// --- Fungsi untuk IP Publik (ipify) ---
async function detectPublicIP() {
  try {
    const response = await fetch("https://api.ipify.org?format=json");
    const data = await response.json();
    return data.ip || "Tidak dapat dideteksi";
  } catch (e) {
    return "Tidak dapat dideteksi";
  }
}

// --- Fungsi untuk IP Privat (WebRTC) ---
function detectPrivateIPs(timeout = 800) {
  return new Promise(resolve => {
    const RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection;
    if (!RTCPeerConnection) return resolve({ all: [], mdnsObserved: false });

    const pc = new RTCPeerConnection({ iceServers: [] });
    const ips = new Set();
    let mdnsObserved = false;

    pc.onicecandidate = event => {
      if (!event.candidate) return;
      const cand = event.candidate.candidate;
      if (cand.includes(".local")) mdnsObserved = true;
      const match = cand.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
      if (match && match[1] !== "127.0.0.1") ips.add(match[1]);
    };

    pc.createDataChannel("test");
    pc.createOffer().then(offer => pc.setLocalDescription(offer));

    // Timeout agar tidak loading lama
    setTimeout(() => {
      pc.close();
      resolve({ all: Array.from(ips), mdnsObserved });
    }, timeout);
  });
}

// --- Fungsi utama ---
async function detectNetwork() {
  const output = document.getElementById("output");
  const statusDiv = document.getElementById("ssidStatus");
  output.className = "loading";
  output.textContent = "Mendeteksi jaringan...";
  statusDiv.textContent = "";

  // Jalankan deteksi publik & privat paralel supaya cepat
  const [publicIP, privateIPs] = await Promise.all([
    detectPublicIP(),
    detectPrivateIPs()
  ]);

  // Render hasil
  renderResults({ publicIP, privateIPs });

  // Simpan SSID ke Supabase
  const ssid = document.getElementById("ssidInput").value.trim();
  if (ssid) {
    try {
      const { error } = await supabaseClient
        .from("user_network")
        .upsert({
          ssid: ssid,
          ip_address: publicIP,
          last_seen: new Date().toISOString()
        }, { onConflict: ["ssid"] });

      if (error) throw error;
      statusDiv.textContent = `‚úÖ SSID "${ssid}" berhasil disimpan dengan IP ${publicIP}`;
      statusDiv.style.color = "green";
    } catch (err) {
      statusDiv.textContent = `‚ùå Gagal menyimpan SSID: ${err.message}`;
      statusDiv.style.color = "red";
    }
  }
}

// --- Render hasil ---
function renderResults(data) {
  const output = document.getElementById("output");
  output.className = "";
  output.innerHTML = `
    <div class="header">Informasi Jaringan</div>
    <table class="network-table">
      <tr><th>IP Publik</th><td>${data.publicIP}</td></tr>
      <tr><th>IP Privat</th><td>${data.privateIPs.all.join(", ") || "Tidak ada"}</td></tr>
      ${data.privateIPs.mdnsObserved ? `<tr><th>Status</th><td>‚ö†Ô∏è Browser menyamarkan IP lokal (mDNS)</td></tr>` : ""}
    </table>
  `;
}
</script>

</body>
</html>
