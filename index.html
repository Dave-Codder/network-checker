<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Network Info</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .network-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #f8f9fa;
      border-radius: 4px;
      overflow: hidden;
    }
    .network-table th, .network-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    .network-table th {
      background-color: #e9ecef;
      font-weight: 600;
      color: #495057;
      width: 40%;
    }
    .network-table tr:last-child td { border-bottom: none; }
    .loading { text-align: center; color: #666; font-style: italic; padding: 20px; }
    .error { color: #dc3545; background-color: #ffe6e6; border: 1px solid #dc3545; padding: 10px; border-radius: 4px; margin-top: 10px; }
    .refresh-button {
      display: block;
      margin: 20px auto 0;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .refresh-button:hover { background-color: #2980b9; }
    #ssidInput { width:100%; margin-top:10px; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:14px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Network Information</h1>
    <div id="output" class="loading">Klik "Refresh Data" untuk memulai deteksi jaringan...</div>
    <div style="margin-top: 20px;">
      <label for="ssidInput"><b>SSID:</b></label>
      <input type="text" id="ssidInput" placeholder="Masukkan nama WiFi (SSID)">
      <div id="ssidStatus" style="margin-top:10px; font-size:13px;"></div>
    </div>
    <button class="refresh-button" onclick="fetchNetworkInfo()">Refresh Data</button>
  </div>

  <script>
    // --- Konfigurasi Supabase ---
    const supabaseUrl = 'https://bbsrfxzdiocqnkpxbgvj.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // pakai key kamu
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // --- Ambil IP Publik via IPfy ---
    async function getPublicIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        return data.ip;
      } catch (e) {
        console.error("Gagal ambil IP publik:", e);
        return "Tidak terdeteksi";
      }
    }

    // --- Ambil IP Private via WebRTC ---
    function getPrivateIPs() {
      return new Promise(resolve => {
        const RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection;
        if (!RTCPeerConnection) return resolve([]);
        const ips = new Set();
        const pc = new RTCPeerConnection({ iceServers: [] });
        pc.createDataChannel("x");
        pc.onicecandidate = (event) => {
          if (!event.candidate) return;
          const match = event.candidate.candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
          if (match && match[1] !== "127.0.0.1") ips.add(match[1]);
        };
        pc.createOffer().then(o => pc.setLocalDescription(o));
        setTimeout(() => { pc.close(); resolve([...ips]); }, 500);
      });
    }

    // --- Render tabel hasil ---
    function renderResults(data) {
      const output = document.getElementById('output');
      output.className = '';
      output.innerHTML = `
        <table class="network-table">
          <tr><th>IP Publik</th><td>${data.publicIP}</td></tr>
          <tr><th>IP Privat</th><td>${data.privateIPs.length ? data.privateIPs.join(', ') : 'Tidak terdeteksi'}</td></tr>
          <tr><th>Subnet Mask</th><td>${data.subnetMask}</td></tr>
          <tr><th>Default Gateway</th><td>${data.gateway}</td></tr>
          <tr><th>Network ID</th><td>${data.networkId}</td></tr>
        </table>
      `;
    }

    // --- Fungsi utama ---
    async function fetchNetworkInfo() {
      const output = document.getElementById('output');
      const ssidStatus = document.getElementById('ssidStatus');
      output.className = 'loading';
      output.textContent = 'Mendeteksi...';

      // Ambil data
      const publicIP = await getPublicIP();
      const privateIPs = await getPrivateIPs();

      let subnetMask = "-", gateway = "-", networkId = "-";
      if (privateIPs.length > 0) {
        const ip = privateIPs[0].split(".").map(Number);
        let mask;
        if (ip[0] === 10) mask = [255,0,0,0];
        else if (ip[0] === 172 && ip[1] >= 16 && ip[1] <= 31) mask = [255,240,0,0];
        else if (ip[0] === 192 && ip[1] === 168) mask = [255,255,255,0];
        if (mask) {
          subnetMask = mask.join(".");
          networkId = ip.map((p,i)=> p & mask[i]).join(".");
          gateway = `${ip[0]}.${ip[1]}.${ip[2]}.1`;
        }
      }

      renderResults({ publicIP, privateIPs, subnetMask, gateway, networkId });

      // Simpan SSID ke Supabase
      const ssid = document.getElementById('ssidInput').value.trim();
      if (ssid) {
        try {
          const now = new Date().toISOString();
          const { error } = await supabaseClient.from('user_network').upsert({
            ssid: ssid,
            ip_address: publicIP,
            last_seen: now
          }, { onConflict: ['ssid'] });
          if (error) throw error;
          ssidStatus.textContent = `✅ SSID "${ssid}" disimpan dengan IP ${publicIP}`;
          ssidStatus.style.color = 'green';
        } catch (err) {
          console.error(err);
          ssidStatus.textContent = `❌ Gagal simpan SSID: ${err.message}`;
          ssidStatus.style.color = 'red';
        }
      }
    }
  </script>
</body>
</html>
