<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Network Info</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .network-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #f8f9fa;
      border-radius: 4px;
      overflow: hidden;
    }
    .network-table th, .network-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    .network-table th {
      background-color: #e9ecef;
      font-weight: 600;
      color: #495057;
      width: 40%;
    }
    .network-table tr:last-child td { border-bottom: none; }
    .loading { text-align: center; color: #666; font-style: italic; padding: 20px; }
    .error { color: #dc3545; background-color: #ffe6e6; border: 1px solid #dc3545; padding: 10px; border-radius: 4px; margin-top: 10px; }
    .refresh-button {
      display: block;
      margin: 20px auto 0;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .refresh-button:hover { background-color: #2980b9; }
    #ssidInput { width:100%; margin-top:10px; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:14px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Network Information</h1>
    <div id="output" class="loading">Klik "Refresh Data" untuk memulai deteksi jaringan...</div>
    <div style="margin-top: 20px;">
      <label for="ssidInput"><b>SSID:</b></label>
      <input type="text" id="ssidInput" placeholder="Masukkan nama WiFi (SSID)">
      <div id="ssidStatus" style="margin-top:10px; font-size:13px;"></div>
    </div>
   <button id="fetchBtn" class="refresh-button">Refresh Data</button>
  </div>
</body>

  <script>
    // --- Konfigurasi Supabase ---
    const supabaseUrl = 'https://bbsrfxzdiocqnkpxbgvj.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJic3JmeHpkaW9jcW5rcHhiZ3ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3Mjg4NjIsImV4cCI6MjA3NDMwNDg2Mn0.hDSjMPDLp9IyzbO6Zs2VeeK5Hh-BkxIobtG92KUHK4U'; // pakai key kamu
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // --- Ambil IP Publik via IPfy ---
    async function getPublicIP() {
      try {
        const res = await fetch(`https://ipinfo.io/json?token=7de3e574f56ab3`);
        const data = await res.json();
        return data.ip;
      } catch (e) {
        console.error("Gagal ambil IP publik:", e);
        return "Tidak terdeteksi";
      }
    }

    // --- Ambil IP Private via WebRTC ---
    function getPrivateIPs() {
      return new Promise(resolve => {
        const RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection;
        if (!RTCPeerConnection) return resolve([]);
        const ips = new Set();
        const pc = new RTCPeerConnection({ iceServers: [] });
        pc.createDataChannel("x");
        pc.onicecandidate = (event) => {
          if (!event.candidate) return;
          const match = event.candidate.candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
          if (match && match[1] !== "127.0.0.1") ips.add(match[1]);
        };
        pc.createOffer().then(o => pc.setLocalDescription(o));
        setTimeout(() => { pc.close(); resolve([...ips]); }, 500);
      });
    }

    // --- Render tabel hasil ---
    function renderResults(data) {
      const output = document.getElementById('output');
      output.className = '';
      output.innerHTML = `
        <table class="network-table">
          <tr><th>IP Publik</th><td>${data.publicIP}</td></tr>
          <tr><th>IP Privat</th><td>${data.privateIPs.length ? data.privateIPs.join(', ') : 'Tidak terdeteksi'}</td></tr>
          <tr><th>Subnet Mask</th><td>${data.subnetMask}</td></tr>
          <tr><th>Default Gateway</th><td>${data.gateway}</td></tr>
          <tr><th>Network ID</th><td>${data.networkId}</td></tr>
        </table>
      `;
    }
  async function fetchNetworkInfo() {
    try {
      // 🔹 1. Ambil IP Publik
      const pubRes = await fetch("https://ipinfo.io/json?token=7de3e574f56ab3");
      const pubData = await pubRes.json();
      const publicIP = pubData.ip || "-";

      // 🔹 2. Ambil info detail dari backend (agent.js atau network.js)
      const netRes = await fetch("http://localhost:5000/network"); // ganti sesuai URL backend
      const netData = await netRes.json();

      // 🔹 3. Gabungkan data
      const networkInfo = {
        ssid: netData.ssid || "Unknown",
        ip_address: publicIP,
        ipv4: netData.ipv4,
        subnetMask: netData.subnetMask,
        defaultGateway: netData.defaultGateway,
        dhcpServer: netData.dhcpServer,
        dnsServers: netData.dnsServers,
        leaseObtained: netData.leaseObtained,
        leaseExpires: netData.leaseExpires,
      };
      console.log("Network Info:", networkInfo);

      // 🔹 4. Simpan ke Supabase
      const { error } = await supabaseClient.from("user_network").insert({
        ssid: networkInfo.ssid,
        ip_address: networkInfo.ip_address,
        last_seen: new Date().toISOString()
      });
      if (error) throw error;

      alert("✅ Data jaringan berhasil disimpan ke Supabase!");
    } catch (err) {
      console.error("❌ Gagal ambil info jaringan:", err);
    }
  }

  // Jalankan saat tombol diklik
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("fetchBtn").addEventListener("click", fetchNetworkInfo);
  });
</script>
</html>
